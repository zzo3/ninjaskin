<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat Overlay</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap');

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', 'PingFang TC', sans-serif;
      background: transparent;
      color: #fff;
    }

    #chat-container {
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 15px;
      max-width: 400px;
      margin: 0 auto;
      max-height: 100vh;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      pointer-events: none;
    }
    #chat-container::-webkit-scrollbar {
      width: 0px;
      background: transparent;
    }
    .message-container * {
      pointer-events: auto;
    }

    .message-container {
      position: relative;
      margin-bottom: 40px;
      will-change: transform, opacity;
      animation: fadeInUp 0.6s ease-out;
    }
    .message-container.fadeout {
      animation: fadeOutUp 10s ease-out forwards;
    }
    .message-container.fadeout:hover {
      transform: translateY(0) scale(1.03);
      opacity: 1;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(40px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOutUp {
      0%   { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-30px); }
    }

    @keyframes flamePulseBlue {
      0%   { box-shadow: 0 0 4px #00f, 0 0 8px #0ff, 0 0 12px #0ff; }
      50%  { box-shadow: 0 0 6px #33f, 0 0 10px #3ff, 0 0 14px #3ff; }
      100% { box-shadow: 0 0 4px #00f, 0 0 8px #0ff, 0 0 12px #0ff; }
    }

    @keyframes scaleUpPulse {
      0%, 100% { transform: scale(1); }
      50%      { transform: scale(1.08); }
    }

    .message {
      position: relative;
      display: inline-block;
      max-width: 100%;
      padding: 5px;
      border-radius: 10px;
      color: #fff;
      word-wrap: break-word;
      font-size: 0.75em;
      text-shadow: 1px 1px 2px #000, 0 0 6px rgba(255,255,255,0.8);
    }

    .message.fireblue {
      background: rgba(0, 100, 255, 0.08);
      animation: flamePulseBlue 1.5s infinite ease-in-out;
    }

    .message.fireblue.boldpulse {
      font-weight: bold;
      animation:
        flamePulseBlue 1.5s infinite ease-in-out,
        scaleUpPulse 1.5s infinite ease-in-out;
    }

    .message.bot {
      background: rgba(200, 200, 200, 0.05);
      border: 1px solid #888;
      color: #ccc;
      font-style: italic;
      box-shadow: none;
      animation: none;
    }

    .username-box {
      position: absolute;
      bottom: 100%;
      left: 0;
      margin-bottom: 3px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
      z-index: 2;
      background: transparent;
      font-size: 0.85em;
      text-shadow: 1px 1px 2px #000;
      opacity: 0.9;
      border: 1px solid #fff;
      display: inline-flex;
      align-items: center;
      flex-wrap: nowrap;
      white-space: nowrap;
    }

    .username-box.youtube {
      color: #FF0000;
      border: 2px solid #FF0000;
      box-shadow: 0 0 6px #FF0000;
    }
    .username-box.twitch {
      color: #9146FF;
      border: 2px solid #9146FF;
      box-shadow: 0 0 6px #9146FF;
    }
    .username-box.kick {
      color: #53fc18;
      border: 2px solid #53fc18;
      box-shadow: 0 0 6px #53fc18;
    }
    .username-box.system {
      color: #ccc;
      border: 1px solid #888;
      box-shadow: none;
      font-style: italic;
    }

    .text {
      line-height: 1.4;
      word-break: break-word;
    }
  </style>
</head>

<body>
  <div id="chat-container"></div>
<script>
  const chatContainer = document.getElementById("chat-container");
  const urlParams = new URLSearchParams(window.location.search);
  const roomID = urlParams.get("session") || "4DP7Stjuew";
  const password = "false";
  const featuredMode = false;

  let joinAnnouncementText = localStorage.getItem("joinAnnouncementText") || "Ê≠°ËøéÂä†ÂÖ•~";

  function addMessageToOverlay(data) {
    if (!data.chatname && data.meta) return;

    const messageContainer = document.createElement("div");
    messageContainer.classList.add("message-container");

    const messageDiv = document.createElement("div");
    messageDiv.classList.add("message");
    if (data.mid) messageDiv.id = data.mid;

    const usernameBox = document.createElement("div");
    usernameBox.classList.add("username-box");
    const platformClass = data.type?.toLowerCase() || "";
    if (["youtube", "twitch", "kick", "system"].includes(platformClass)) {
      usernameBox.classList.add(platformClass);
    }

    const platformEmoji = {
      youtube: "‚ù§Ô∏è",
      kick: "üíö",
      twitch: "üíú"
    };
    const emoji = platformEmoji[platformClass] || "";
    usernameBox.innerText = `${emoji} ${data.chatname || "ÂåøÂêç"}`;

    const textDiv = document.createElement("div");
    textDiv.classList.add("text");
    textDiv.innerHTML = data.chatmessage || "";

    messageDiv.appendChild(usernameBox);
    messageDiv.appendChild(textDiv);

    const isBot = ["system", "bot"].includes(platformClass);
    const isSpecialEvent = ["ËøΩÈö®", "Ë®ÇÈñ±", "Âä†ÂÖ•ÊúÉÂì°", "follow", "subscribe", "member", "joined"]
      .some(keyword => (data.chatmessage || "").toLowerCase().includes(keyword));

    if (isBot) {
      messageDiv.classList.add("bot");
    } else if (isSpecialEvent) {
      messageDiv.classList.add("fireblue", "boldpulse");
    } else {
      messageDiv.classList.add("fireblue");
    }

    const borderColors = [
      "#00ffff", "#08f8f8", "#0ff0f0", "#17e9e9", "#1ee1e1", "#26dada",
      "#2dd2d2", "#35cbcb", "#3cc3c3", "#44bcbc", "#4bb4b4", "#53adad"
    ];
    const randomColor = borderColors[Math.floor(Math.random() * borderColors.length)];
    messageDiv.style.border = `1px solid ${randomColor}`;

    messageContainer.appendChild(messageDiv);
    chatContainer.appendChild(messageContainer);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    setTimeout(() => {
      messageContainer.classList.add("fadeout");
    }, 15000);

    setTimeout(() => {
      if (messageContainer.parentNode) {
        messageContainer.parentNode.removeChild(messageContainer);
      }
    }, 60000);
  }

  document.addEventListener("DOMContentLoaded", () => {
    addMessageToOverlay({
      chatname: "Á≥ªÁµ±",
      chatmessage: "ËÅäÂ§©ÂÆ§Â∑≤Âä†Ëºâ",
      type: "system"
    });

    const iframe = document.createElement("iframe");
    iframe.src = featuredMode
      ? `https://vdo.socialstream.ninja/?ln&password=${password}&salt=vdo.ninja&label=overlay&exclude=${roomID}&scene&novideo&noaudio&cleanoutput&room=${roomID}`
      : `https://vdo.socialstream.ninja/?ln&salt=vdo.ninja&password=${password}&push&label=dock&vd=0&ad=0&novideo&noaudio&autostart&cleanoutput&room=${roomID}`;
    iframe.style.cssText = "width: 0px; height: 0px; position: fixed; left: -100px; top: -100px;";
    document.body.appendChild(iframe);

    window.addEventListener("message", (event) => {
      if (event.source !== iframe.contentWindow) return;
      const data = event.data?.dataReceived?.overlayNinja;
      if (!data) return;

      addMessageToOverlay(data);

      const joinKeywords = ["Âä†ÂÖ•ÊúÉÂì°", "subscribe", "follow", "Êñ∞ËßÄÁúæ", "joined"];
      const messageText = (data.chatmessage || "").toLowerCase();
      const isJoinEvent = joinKeywords.some(keyword => messageText.includes(keyword));

      if (isJoinEvent && joinAnnouncementText) {
        addMessageToOverlay({
          chatname: "üì¢ ÂÖ¨Âëä",
          chatmessage: joinAnnouncementText,
          type: "system"
        });
      }
    });

    const announcementChannel = new BroadcastChannel("announcements");
    announcementChannel.addEventListener("message", (event) => {
      const { text, type } = event.data || {};
      if (!text) return;

      if (type === "join-trigger") {
        joinAnnouncementText = text;
        localStorage.setItem("joinAnnouncementText", text);
        console.log("üì• Â∑≤Êõ¥Êñ∞Âä†ÂÖ•ÂÖ¨ÂëäÂÖßÂÆπÔºö", joinAnnouncementText);
        return;
      }

      let label = "Á≥ªÁµ±";
      if (type === "announcement") label = "üì¢ ÂÖ¨Âëä";
      else if (type === "tip") label = "üí° ÊèêÁ§∫";
      else if (type === "test") label = "üß™ Ê∏¨Ë©¶";

      console.log("üì• Êî∂Âà∞ BroadcastChannel Ë®äÊÅØÔºö", { type, text });

      addMessageToOverlay({
        chatname: label,
        chatmessage: text,
        type: "system"
      });
    });

    // ‚úÖ WebSocket Êé•Êî∂ÈÇèËºØ
    const socket = new WebSocket("wss://ninjaskin-production.up.railway.app");
    socket.addEventListener("message", (event) => {
      const { text, type } = JSON.parse(event.data || "{}");
      if (!text) return;

      if (type === "join-trigger") {
        joinAnnouncementText = text;
        localStorage.setItem("joinAnnouncementText", text);
        console.log("üì• WebSocket Êõ¥Êñ∞Âä†ÂÖ•ÂÖ¨ÂëäÂÖßÂÆπÔºö", joinAnnouncementText);
        return;
      }

      let label = "Á≥ªÁµ±";
      if (type === "announcement") label = "üì¢ ÂÖ¨Âëä";
      else if (type === "tip") label = "üí° ÊèêÁ§∫";
      else if (type === "test") label = "üß™ Ê∏¨Ë©¶";

      console.log("üì• Êî∂Âà∞ WebSocket Ë®äÊÅØÔºö", { type, text });

      addMessageToOverlay({
        chatname: label,
        chatmessage: text,
        type: "system"
      });
    });
  });
</script>
</body>
</html>
