<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Neon Overlay</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

    body, html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: rgba(5, 5, 10, 0);
        font-family: 'Roboto', sans-serif;
        color: #e0e0ff;
        font-size: 70%;
    }

    #chat-container {
        padding: 25px;
        max-width: 420px;
        height: 100%;
        overflow-y: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
        margin: auto;
        scroll-behavior: smooth;
    }
    #chat-container::-webkit-scrollbar { display: none; }

    .message-container { position: relative; margin-bottom: 18px; }

    .message {
        display: inline-block;
        max-width: 100%;
        background: rgba(20,20,40,0.25);
        border: 2px solid #00f0ff;
        border-radius: 14px;
        padding: 28px 14px 14px 14px;
        margin-top: 28px;
        margin-left: 20px;
        color: #e0e0ff;
        box-shadow: 0 0 12px #00f0ff, 0 0 24px #8000ff;
        opacity: 0;
        transform: translateX(-25px);
        animation: neonSlideIn 0.7s ease forwards;
        word-wrap: break-word;
        transition: all 0.3s ease;
    }

    .username-box {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        position: absolute;
        top: -24px;
        left: 12px;
        padding: 6px 12px;
        font-weight: 600;
        font-size: 100%;
        background: rgba(0,0,0,0.4);
        border: 1px solid #8000ff;
        border-radius: 8px;
        z-index: 2;
    }

    .username-box.twitch {
        color: #9146FF;
        border-color: #9146FF;
        text-shadow: 0 0 8px #9146FF;
    }
    .username-box.youtube {
        color: #FF0000;
        border-color: #FF0000;
        text-shadow: 0 0 8px #FF0000;
    }
    .username-box.kick {
        color: #53FC18;
        border-color: #53FC18;
        text-shadow: 0 0 8px #53FC18;
    }

    .source-icon {
        width: 25px;
        height: 25px;
        margin-right: 6px;
        vertical-align: middle;
        filter: drop-shadow(0 0 4px currentColor);
    }

    .message.bot {
        border: 2px solid #555;
        box-shadow: 0 0 8px #333;
        background: rgba(20,20,20,0.25);
        color: #aaa;
    }

    .event-message {
        display: inline-block;
        max-width: 100%;
        background: rgba(10, 0, 20, 0.85);
        border-radius: 16px;
        padding: 20px;
        margin: 20px auto;
        font-weight: bold;
        text-align: center;
        border: 3px solid transparent;
        background-image: linear-gradient(rgba(10,0,20,0.85), rgba(10,0,20,0.85)),
                          linear-gradient(90deg, #ff00ff, #00f0ff, #ff00ff);
        background-origin: border-box;
        background-clip: content-box, border-box;
        box-shadow: 0 0 20px #ff00ff, 0 0 40px #00f0ff;
        opacity: 0;
        transform: scale(0.9);
        animation: neonEventIn 1s ease forwards, gradientShift 3s linear infinite;
    }
    .event-message span {
        background: linear-gradient(90deg, #ff00ff, #00f0ff, #ff00ff);
        background-size: 200% auto;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: textGradientShift 3s linear infinite;
    }

    .text { font-size: 100%; line-height: 1.5; }

    @keyframes neonSlideIn {
        from { opacity: 0; transform: translateY(25px) scale(0.95); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes neonEventIn {
        0% { opacity: 0; transform: scale(0.8); }
        60% { opacity: 1; transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    @keyframes gradientShift {
        0% { background-image: linear-gradient(rgba(10,0,20,0.85), rgba(10,0,20,0.85)), linear-gradient(90deg, #ff00ff, #00f0ff, #ff00ff); }
        50% { background-image: linear-gradient(rgba(10,0,20,0.85), rgba(10,0,20,0.85)), linear-gradient(90deg, #00f0ff, #ff00ff, #00f0ff); }
        100% { background-image: linear-gradient(rgba(10,0,20,0.85), rgba(10,0,20,0.85)), linear-gradient(90deg, #ff00ff, #00f0ff, #ff00ff); }
    }
    @keyframes textGradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
  </style>
</head>
<body>
  <div id="chat-container"></div>

<script>
  const chatContainer = document.getElementById('chat-container');
  let lastSender = null;
  let lastMessageDiv = null;

  const urlParams = new URLSearchParams(window.location.search);
  const roomID = urlParams.get("session") || "7RUWtGBfz2";
  const password = "false";
  const featuredMode = false;

  function applyOverlaySize() {
    const size = urlParams.get('size');
    document.body.classList.remove("small-overlay", "large-overlay");
    if (size === "small") document.body.classList.add("small-overlay");
    else if (size === "large") document.body.classList.add("large-overlay");
  }

  function isFullyVisible(element) {
    const containerRect = chatContainer.getBoundingClientRect();
    const elementRect = element.getBoundingClientRect();
    return elementRect.top >= containerRect.top && elementRect.bottom <= containerRect.bottom;
  }

  function removeCutOffMessages() {
    let firstMessage = chatContainer.firstElementChild;
    while (firstMessage && !isFullyVisible(firstMessage)) {
      chatContainer.removeChild(firstMessage);
      firstMessage = chatContainer.firstElementChild;
    }
  }

  function autoScroll() {
    const lastMessage = chatContainer.lastElementChild;
    if (lastMessage) {
      lastMessage.scrollIntoView({ behavior: "instant", block: "end" });
      setTimeout(() => {
        lastMessage.scrollIntoView({ behavior: "instant", block: "end" });
        removeCutOffMessages();
      }, 50);
    }
  }

  const observer = new MutationObserver(autoScroll);
  observer.observe(chatContainer, { childList: true, subtree: true });

  // ‰∫ã‰ª∂Ë®äÊÅØ
  function addEventToOverlay(data) {
    const eventDiv = document.createElement('div');
    eventDiv.classList.add('event-message');
    let eventText = '';
    if (data.type === 'follow') eventText = `${data.chatname} just followed!`;
    else if (data.type === 'subscription') eventText = `${data.chatname} subscribed!`;
    else if (data.type === 'donation') eventText = `${data.chatname} donated ${data.amount || ''}!`;
    eventDiv.innerHTML = `<span>üéâ ${eventText} üéâ</span>`;
    chatContainer.appendChild(eventDiv);
  }

  // ËÅäÂ§©Ë®äÊÅØ
  function addMessageToOverlay(data) {
    if (!data || !data.chatname || !data.chatmessage) return;
    if (['follow','subscription','donation'].includes(data.type)) {
      addEventToOverlay(data);
      return;
    }

    if (lastSender === data.chatname && lastMessageDiv) {
      const textDiv = document.createElement('div');
      textDiv.classList.add('text');
      textDiv.innerHTML = data.chatmessage;
      lastMessageDiv.querySelector('.message').appendChild(textDiv);
    } else {
      const messageContainer = document.createElement('div');
      messageContainer.classList.add('message-container');

      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message');
      if (data.type === 'bot') messageDiv.classList.add('bot');

      // Âπ≥Âè∞ icon
      let sourceIcon = '';
      if (data.type && data.type !== 'bot') {
        const providerName = data.type.charAt(0).toUpperCase() + data.type.slice(1);
        const iconUrl = `https://socialstream.ninja/sources/images/${data.type}.png`;
        sourceIcon = `<img src="${iconUrl}" alt="${providerName}" class="source-icon" onerror="this.remove();">`;
      }

      // ÂæΩÁ´†
      let chatbadges = "";
      if (data.chatbadges) {
        data.chatbadges.slice(0, 1).forEach(badge => {
          if (badge.type === "img" && badge.src) {
            chatbadges += `<img class='badge' src='${badge.src}' />`;
          } else if (badge.type === "svg" && badge.html) {
            chatbadges += `<span class='badge svg'>${badge.html}</span>`;
          }
        });
      }

      messageDiv.innerHTML = `
        <div class="username-box ${data.type || ''}">
          ${sourceIcon}
          <span>${data.chatname}</span>
          <span class="badges">${chatbadges}</span>
        </div>
        <div class="text">${data.chatmessage}</div>
      `;

      messageContainer.appendChild(messageDiv);
      chatContainer.appendChild(messageContainer);

      lastSender = data.chatname;
      lastMessageDiv = messageContainer;
    }
  }

  // iframe ÈÄ£Êé•
  const iframe = document.createElement("iframe");
  iframe.src = featuredMode
    ? `https://vdo.socialstream.ninja/?ln&password=${password}&salt=vdo.ninja&label=overlay&exclude=${roomID}&scene&novideo&noaudio&cleanoutput&room=${roomID}`
    : `https://vdo.socialstream.ninja/?ln&salt=vdo.ninja&password=${password}&push&label=dock&vd=0&ad=0&novideo&noaudio&autostart&cleanoutput&room=${roomID}`;
  iframe.style.cssText = "width:0;height:0;position:fixed;left:-100px;top:-100px;";
  document.body.appendChild(iframe);

  window.addEventListener("message", (event) => {
    if (event.source !== iframe.contentWindow) return;
    if (event.data.dataReceived && event.data.dataReceived.overlayNinja) {
      addMessageToOverlay(event.data.dataReceived.overlayNinja);
    }
  });

  document.addEventListener('DOMContentLoaded', applyOverlaySize);

  // WebSocket ÈÄ£Êé•
  let conCon = 1;
  let socketserver = false;
  let serverURL = urlParams.has("localserver") ? "ws://127.0.0.1:3000" : "wss://io.socialstream.ninja";

  function setupSocket() {
    socketserver.onclose = function () {
      setTimeout(function () {
        conCon += 1;
        socketserver = new WebSocket(serverURL);
        setupSocket();
      }, 100 * conCon);
    };
    socketserver.onopen = function () {
      conCon = 1;
      socketserver.send(JSON.stringify({ "join": roomID, "out": 3, "in": 4 }));
    };
    socketserver.addEventListener('message', function (event) {
      if (event.data) {
        const data = JSON.parse(event.data);
        addMessageToOverlay(data);
        if (data.get) {
          socketserver.send(JSON.stringify({ callback: { get: data.get, result: true } }));
        }
      }
    });
  }

  if (urlParams.has("server") || urlParams.has("server2")) {
    serverURL = urlParams.get("server") || urlParams.get("server2") || serverURL;
    socketserver = new WebSocket(serverURL);
    setupSocket();
  }
</script>
</body>
</html>

